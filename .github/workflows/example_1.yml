name: Check Tickets (Shell Only)
on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *' # 5분마다 자동 실행
jobs:
  job:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      PRODUCT_ID: 211782
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
    # -------------------------------------------------------------
    # 1일차 공연 (schedule-id: 100001) 감시 시작
    # -------------------------------------------------------------

    # 1. 🥇 1일차 VIP 등급 감시
    - name: Check Tickets - VIP 등급 (1일차)
      run: |
        # API 호출 및 잔여석 확인 (API 응답에 "success":true가 포함되면 잔여석 있다고 가정)
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100001&seatId=10000")
        
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "VIP 좌석 (1일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 VIP 좌석 풀렸습니다! (1일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "VIP 좌석 (1일차) 잔여석 없음."
        fi

    # 2. 🥈 1일차 R 등급 감시
    - name: Check Tickets - R 등급 (1일차)
      run: |
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100001&seatId=10008")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "R 등급 (1일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 일반석 풀렸습니다! (1일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "R 등급 (1일차) 잔여석 없음."
        fi

    # 3. 🥉 1일차 S 등급 감시
    - name: Check Tickets - S 등급 (1일차)
      run: |
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100001&seatId=12051")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "S 등급 (1일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 시제석 풀렸습니다! (1일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "S 등급 (1일차) 잔여석 없음."
        fi

    # -------------------------------------------------------------
    # 2일차 공연 (schedule-id: 100002) 감시 시작
    # -------------------------------------------------------------

    # 4. 🥇 2일차 VIP 등급 감시
    - name: Check Tickets - VIP 등급 (2일차)
      run: |
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100002&seatId=10000")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "VIP 좌석 (2일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 VIP 좌석 풀렸습니다! (2일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "VIP 좌석 (2일차) 잔여석 없음."
        fi

    # 5. 🥈 2일차 R 등급 감시
    - name: Check Tickets - R 등급 (2일차)
      run: |
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100002&seatId=10008")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "R 등급 (2일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 일반석 풀렸습니다! (2일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "R 등급 (2일차) 잔여석 없음."
        fi

    # 6. 🥉 2일차 S 등급 감시
    - name: Check Tickets - S 등급 (2일차)
      run: |
        RESPONSE=$(curl -s "https://ticket.melon.com/api/web/product/schedule.json?pId=${{ env.PRODUCT_ID }}&sId=100002&seatId=12051")
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "S 등급 (2일차) 잔여석 발견! 슬랙 알림 전송."
          curl -X POST -H 'Content-type: application/json' --data '{"text":"📢 시제석 풀렸습니다! (2일차) 즉시 구매하세요!!\n링크: https://ticket.melon.com/performance/index.htm?prodId=${{ env.PRODUCT_ID }}"}' ${{ env.SLACK_WEBHOOK_URL }}
        else
          echo "S 등급 (2일차) 잔여석 없음."
        fi
